<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Realtime Hiện Đại</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --background-light: #f8f9fa;
        --background-dark: #343a40;
        --text-color-light: #333;
        --text-color-dark: #fff;
        --border-color: #dee2e6;
        --chat-bubble-bg-self: #dcf8c6;
        --chat-bubble-bg-other: #e9ecef;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: var(--background-light);
        color: var(--text-color-light);
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        width: 100%;
        max-width: 400px;
        height: 100vh;
        max-height: 800px;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        background-color: var(--text-color-dark);
      }

      /* Login/Register Form Styles */
      .auth-form {
        padding: 20px;
        display: flex;
        flex-direction: column;
        background-color: #fff;
      }

      .auth-form h2 {
        text-align: center;
        margin-bottom: 20px;
        color: var(--primary-color);
      }

      .auth-form input {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 1em;
      }

      .auth-form button {
        background-color: var(--primary-color);
        color: #fff;
        border: none;
        padding: 10px;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .auth-form button:hover {
        background-color: #0056b3;
      }

      .auth-toggle {
        text-align: center;
        margin-top: 10px;
        font-size: 0.9em;
      }

      .auth-toggle a {
        color: var(--primary-color);
        cursor: pointer;
        text-decoration: none;
      }

      .status-message {
        text-align: center;
        color: green;
        font-style: italic;
        margin-top: 10px;
      }

      /* Lobby Styles */
      .lobby-ui {
        padding: 20px;
        background-color: var(--background-light);
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .lobby-ui h2 {
        text-align: center;
        color: var(--primary-color);
      }

      .room-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      
      .refresh-btn {
          border: none;
          background: none;
          color: var(--primary-color);
          cursor: pointer;
          font-size: 1.2em;
      }

      .room-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
      }

      .room-item {
        background-color: #fff;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .room-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .join-room-form {
        display: flex;
        margin-top: 20px;
      }

      .join-room-form input {
        flex-grow: 1;
        border: 1px solid var(--border-color);
        border-radius: 25px;
        padding: 10px 15px;
        margin-right: 10px;
        font-size: 1em;
        outline: none;
      }

      .join-room-form button {
        background-color: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 25px;
        padding: 10px 18px;
        font-size: 1em;
        cursor: pointer;
      }
      
      /* Chat UI Styles */
      .chat-ui {
        display: none;
        flex-direction: column;
        flex-grow: 1;
      }
      
      .chat-header {
        background-color: var(--primary-color);
        color: var(--text-color-dark);
        padding: 15px 20px;
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      
      .chat-header i {
        margin-right: 10px;
      }

      .back-to-lobby {
        position: absolute;
        left: 15px;
        color: var(--text-color-dark);
        font-size: 1.5em;
        cursor: pointer;
      }
      
      .chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        list-style: none;
        margin: 0;
        background-color: var(--background-light);
      }

      .chat-messages li {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
      }

      .chat-messages li.self {
        align-items: flex-end;
      }

      .chat-messages li.other {
        align-items: flex-start;
      }

      .message-info {
        font-size: 0.8em;
        color: var(--secondary-color);
        margin-bottom: 5px;
      }

      .message-bubble {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        line-height: 1.4;
        position: relative;
        word-wrap: break-word;
      }

      .message-bubble.self {
        background-color: var(--chat-bubble-bg-self);
        color: var(--text-color-light);
        border-bottom-right-radius: 2px;
      }

      .message-bubble.other {
        background-color: var(--chat-bubble-bg-other);
        color: var(--text-color-light);
        border-bottom-left-radius: 2px;
      }

      .chat-input-form {
        display: flex;
        padding: 15px 20px;
        border-top: 1px solid var(--border-color);
        background-color: var(--text-color-dark);
      }

      .chat-input-form input {
        flex-grow: 1;
        border: 1px solid var(--border-color);
        border-radius: 25px;
        padding: 10px 15px;
        margin-right: 10px;
        font-size: 1em;
        outline: none;
        transition: border-color 0.3s;
      }

      .chat-input-form input:focus {
        border-color: var(--primary-color);
      }

      .chat-input-form button {
        background-color: var(--primary-color);
        color: var(--text-color-dark);
        border: none;
        border-radius: 25px;
        padding: 10px 18px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-input-form button:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
      }

      .chat-input-form button i {
        margin-left: 5px;
      }

      .status-message {
        text-align: center;
        color: green;
        font-style: italic;
        margin-top: 10px;
      }

      .chat-messages .status {
        text-align: center;
        font-style: italic;
        font-size: 0.9em;
        color: var(--secondary-color);
        margin-bottom: 10px;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .container {
          height: 100vh;
          max-height: none;
          border-radius: 0;
          box-shadow: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="auth-ui" class="auth-form">
        <h2>Đăng nhập</h2>
        <input type="text" id="auth-username" placeholder="Tên tài khoản" />
        <input type="password" id="auth-password" placeholder="Mật khẩu" />
        <button id="auth-button">Đăng nhập</button>
        <div class="auth-toggle">
          Chưa có tài khoản? <a id="toggle-auth">Đăng ký</a>
        </div>
        <p id="auth-status" class="status-message"></p>
      </div>

      <div id="lobby-ui" class="lobby-ui" style="display: none;">
        <div class="room-list-header">
          <h2>Phòng Chat</h2>
          <button id="refresh-rooms" class="refresh-btn"><i class="fas fa-sync-alt"></i></button>
        </div>
        <ul id="room-list" class="room-list"></ul>
        <form id="join-room-form" class="join-room-form">
          <input
            id="room-input"
            autocomplete="off"
            placeholder="Tên phòng mới"
          /><button type="submit">Tham gia/Tạo phòng</button>
        </form>
      </div>

      <div id="chat-ui" class="chat-ui">
        <div class="chat-header">
          <i class="fas fa-arrow-left back-to-lobby"></i>
          <span id="room-title">Phòng Chat</span>
        </div>
        <ul id="messages" class="chat-messages"></ul>
        <form id="form" class="chat-input-form">
          <input
            id="input"
            autocomplete="off"
            placeholder="Nhập tin nhắn..."
          /><button type="submit">
            Gửi <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const authUi = document.getElementById('auth-ui');
      const lobbyUi = document.getElementById('lobby-ui');
      const chatUi = document.getElementById('chat-ui');

      const authUsernameInput = document.getElementById('auth-username');
      const authPasswordInput = document.getElementById('auth-password');
      const authButton = document.getElementById('auth-button');
      const authToggle = document.getElementById('toggle-auth');
      const authStatus = document.getElementById('auth-status');

      const roomList = document.getElementById('room-list');
      const refreshRoomsBtn = document.getElementById('refresh-rooms');
      const roomInput = document.getElementById('room-input');
      const joinRoomForm = document.getElementById('join-room-form');

      const roomTitle = document.getElementById('room-title');
      const backToLobbyBtn = document.querySelector('.back-to-lobby');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');

      let isRegisterMode = false;
      let myUsername = '';
      let currentRoom = '';

      function showAuthUI() {
        authUi.style.display = 'flex';
        lobbyUi.style.display = 'none';
        chatUi.style.display = 'none';
      }

      function showLobbyUI() {
        authUi.style.display = 'none';
        lobbyUi.style.display = 'flex';
        chatUi.style.display = 'none';
      }

      function showChatUI() {
        authUi.style.display = 'none';
        lobbyUi.style.display = 'none';
        chatUi.style.display = 'flex';
      }

      function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
      }

      function appendMessage(data) {
        const item = document.createElement('li');
        
        if (data.type === 'status') {
          item.classList.add('status');
          item.textContent = data.text;
        } else {
          // Tin nhắn bình thường
          const bubble = document.createElement('div');
          bubble.classList.add('message-bubble');
          
          if (data.sender === myUsername) {
            item.classList.add('self');
            bubble.classList.add('self');
          } else {
            item.classList.add('other');
            bubble.classList.add('other');
            const senderInfo = document.createElement('span');
            senderInfo.classList.add('message-info');
            senderInfo.textContent = data.sender;
            item.appendChild(senderInfo);
          }
          
          bubble.textContent = data.text;
          item.appendChild(bubble);
        }
        
        messages.appendChild(item);
      }
      
      // Xử lý sự kiện Auth
      authToggle.addEventListener('click', () => {
        isRegisterMode = !isRegisterMode;
        authStatus.textContent = '';
        if (isRegisterMode) {
          document.querySelector('#auth-ui h2').textContent = 'Đăng ký';
          authButton.textContent = 'Đăng ký';
          authToggle.textContent = 'Đăng nhập';
        } else {
          document.querySelector('#auth-ui h2').textContent = 'Đăng nhập';
          authButton.textContent = 'Đăng nhập';
          authToggle.textContent = 'Đăng ký';
        }
      });

      authButton.addEventListener('click', () => {
        const username = authUsernameInput.value;
        const password = authPasswordInput.value;
        if (isRegisterMode) {
          socket.emit('register', { username, password });
        } else {
          socket.emit('login', { username, password });
        }
      });
      
      socket.on('register_status', (data) => {
        authStatus.textContent = data.message;
        authStatus.style.color = data.success ? 'green' : 'red';
        if (data.success) {
          isRegisterMode = false;
          authToggle.click();
        }
      });

      socket.on('login_status', (data) => {
        if (data.success) {
          myUsername = data.username;
          showLobbyUI();
        } else {
          authStatus.textContent = data.message;
          authStatus.style.color = 'red';
        }
      });

      // Xử lý sự kiện Lobby
      socket.on('room_list', (rooms) => {
        roomList.innerHTML = ''; // Xóa danh sách cũ
        rooms.forEach((room) => {
          const li = document.createElement('li');
          li.classList.add('room-item');
          li.textContent = room;
          li.addEventListener('click', () => {
            socket.emit('join_room', room);
          });
          roomList.appendChild(li);
        });
      });

      refreshRoomsBtn.addEventListener('click', () => {
        socket.emit('room_list', null);
      });

      joinRoomForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const roomName = roomInput.value.trim();
        if (roomName) {
          socket.emit('join_room', roomName);
          roomInput.value = '';
        }
      });

      // Xử lý sự kiện Chat
      socket.on('room_joined', (data) => {
        currentRoom = data.roomName;
        roomTitle.textContent = data.roomName;
        messages.innerHTML = ''; // Xóa tin nhắn cũ của phòng trước
        
        // Hiển thị lịch sử tin nhắn
        data.history.forEach(appendMessage);
        
        showChatUI();
        scrollToBottom();
      });

      backToLobbyBtn.addEventListener('click', () => {
        socket.emit('join_room', null);
        showLobbyUI();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit('chat message', input.value);
          input.value = '';
        }
      });

      socket.on('chat message', (data) => {
        appendMessage(data);
        scrollToBottom();
      });

      // Bắt đầu ứng dụng
      showAuthUI();
    </script>
  </body>
</html>